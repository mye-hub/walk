<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å¥èµ°è¿½è¹¤å™¨ï¼ˆå®Œæ•´ç©©å®šç‰ˆï¼‰</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
body{margin:0;font-family:system-ui;background:#f5f7fb}
header{background:#fff;padding:12px;border-bottom:1px solid #eee}
.container{max-width:1100px;margin:auto;padding:12px}
.card{background:#fff;border-radius:10px;padding:12px;margin-bottom:12px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
button{background:#1e88e5;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
button.alt{background:#4caf50}
button.gray{background:#9e9e9e}
button.danger{background:#ef4444}
.metric{flex:1;background:#f2f5f9;padding:8px;border-radius:8px;text-align:center}
.metric b{font-size:18px}
#map{height:420px;border-radius:8px}
.record{padding:6px;border-bottom:1px solid #eee}
.record:hover{background:#f2f5f9}
.small{font-size:13px;color:#666}
.badge{background:#e8f0ff;padding:2px 6px;border-radius:6px}
</style>
</head>

<body>

<header>
  <h2>ğŸš¶ å¥èµ°è¿½è¹¤å™¨ï¼ˆå®Œæ•´ç©©å®šç‰ˆï¼‰</h2>
</header>

<div class="container">

<!-- åœ°åœ– -->
<div class="card">
  <div id="map"></div>
</div>

<!-- æ§åˆ¶ -->
<div class="card row">
  <button id="startBtn">é–‹å§‹å¥èµ°</button>
  <button id="stopBtn" class="alt" disabled>çµæŸ</button>
  <button id="saveBtn" disabled>å„²å­˜ç´€éŒ„</button>
</div>

<!-- å³æ™‚æ•¸æ“š -->
<div class="card row">
  <div class="metric">æ™‚é–“<br><b id="time">00:00:00</b></div>
  <div class="metric">è·é›¢ (km)<br><b id="dist">0.00</b></div>
</div>

<!-- ç¯©é¸ -->
<div class="card row">
  <b>æ—¥æœŸç¯©é¸</b>
  <input type="date" id="dateFilter">
  <button class="gray" onclick="clearFilter()">å…¨éƒ¨</button>
</div>

<!-- ç´€éŒ„ -->
<div class="card">
  <b>å¥èµ°ç´€éŒ„</b>
  <div id="history" class="small">å°šç„¡ç´€éŒ„</div>
</div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ===== åœ°åœ– ===== */
let map = L.map('map')
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)

navigator.geolocation.getCurrentPosition(p=>{
  map.setView([p.coords.latitude, p.coords.longitude],16)
})

let marker = null
let liveLine = null
let replayLine = null

/* ===== ç‹€æ…‹ ===== */
let watchId = null
let timer = null
let startTime = null
let currentSession = null

/* ===== å„²å­˜ ===== */
function load(){
  return JSON.parse(localStorage.getItem('walk_records') || '[]')
}
function save(arr){
  localStorage.setItem('walk_records', JSON.stringify(arr))
}

/* ===== è¨ˆç®— ===== */
function format(sec){
  const h = String(Math.floor(sec/3600)).padStart(2,'0')
  sec %= 3600
  const m = String(Math.floor(sec/60)).padStart(2,'0')
  const s = String(sec%60).padStart(2,'0')
  return `${h}:${m}:${s}`
}

function hav(a,b){
  const R=6371000,toR=x=>x*Math.PI/180
  const dLat=toR(b.lat-a.lat), dLng=toR(b.lng-a.lng)
  return 2*R*Math.asin(Math.sqrt(
    Math.sin(dLat/2)**2 +
    Math.cos(toR(a.lat))*Math.cos(toR(b.lat))*Math.sin(dLng/2)**2
  ))
}

function calcDist(path){
  let d=0
  for(let i=1;i<path.length;i++) d+=hav(path[i-1],path[i])
  return d/1000
}

/* ===== GPS ===== */
function onPos(p){
  const pt={lat:p.coords.latitude, lng:p.coords.longitude}

  if(!marker) marker=L.marker(pt).addTo(map)
  else marker.setLatLng(pt)

  if(!liveLine) liveLine=L.polyline([],{color:'#1e88e5'}).addTo(map)
  liveLine.addLatLng(pt)

  currentSession.path.push(pt)
}

/* ===== é–‹å§‹ ===== */
startBtn.onclick=()=>{
  currentSession={
    id:Date.now(),
    dateOnly:new Date().toISOString().slice(0,10),
    path:[]
  }

  if(liveLine){map.removeLayer(liveLine); liveLine=null}
  if(replayLine){map.removeLayer(replayLine); replayLine=null}

  startTime=Date.now()
  timer=setInterval(updateStats,1000)
  watchId=navigator.geolocation.watchPosition(onPos)

  startBtn.disabled=true
  stopBtn.disabled=false
}

/* ===== å³æ™‚æ›´æ–° ===== */
function updateStats(){
  const sec=Math.floor((Date.now()-startTime)/1000)
  time.innerText=format(sec)
  dist.innerText=calcDist(currentSession.path).toFixed(2)
}

/* ===== çµæŸ ===== */
stopBtn.onclick=()=>{
  navigator.geolocation.clearWatch(watchId)
  clearInterval(timer)
  stopBtn.disabled=true
  saveBtn.disabled=false
}

/* ===== å„²å­˜ ===== */
saveBtn.onclick=()=>{
  if(currentSession.path.length<2){
    alert('è³‡æ–™ä¸è¶³ï¼Œç„¡æ³•å„²å­˜')
    return
  }
  const rec={
    id:currentSession.id,
    dateOnly:currentSession.dateOnly,
    durationSec:Math.floor((Date.now()-startTime)/1000),
    distanceKm:+calcDist(currentSession.path).toFixed(2),
    path:currentSession.path,
    source:'gps'
  }
  const arr=load()
  arr.push(rec)
  save(arr)

  currentSession=null
  saveBtn.disabled=true
  startBtn.disabled=false
  render()
}

/* ===== é¡¯ç¤º ===== */
function render(){
  const f=dateFilter.value
  const arr=load().filter(r=>!f||r.dateOnly===f)

  history.innerHTML = arr.length===0
    ? 'å°šç„¡ç´€éŒ„'
    : arr.map(r=>`
      <div class="record">
        ğŸ“… ${r.dateOnly}ï½œ
        â± ${Math.round(r.durationSec/60)} åˆ†ï½œ
        ${r.distanceKm} kmï½œ
        <span class="badge">${r.source}</span>
        <button class="gray" onclick="play(${r.id})">å›æ”¾</button>
        <button class="danger" onclick="del(${r.id})">åˆªé™¤</button>
      </div>
    `).join('')
}

/* ===== å›æ”¾ ===== */
function play(id){
  const r=load().find(x=>x.id===id)
  if(!r||!r.path) return
  if(replayLine) map.removeLayer(replayLine)
  replayLine=L.polyline(r.path,{color:'red'}).addTo(map)
  map.fitBounds(replayLine.getBounds())
}

/* ===== åˆªé™¤ ===== */
function del(id){
  if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return
  save(load().filter(r=>r.id!==id))
  render()
}

function clearFilter(){
  dateFilter.value=''
  render()
}

dateFilter.onchange=render
render()
</script>

</body>
</html>
