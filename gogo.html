<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å¥èµ°è¿½è¹¤å™¨ï¼ˆå®Œæ•´åŠŸèƒ½ç‰ˆï¼‰</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
body{margin:0;font-family:system-ui;background:#f5f7fb}
header{background:#fff;padding:12px 16px;border-bottom:1px solid #eee}
.container{max-width:1100px;margin:auto;padding:12px}
.card{background:#fff;border-radius:10px;padding:12px;margin-bottom:12px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
button{background:#1e88e5;color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer}
button.alt{background:#4caf50}
button.danger{background:#ef4444}
button.gray{background:#9e9e9e}
.metric{flex:1;background:#f2f5f9;padding:8px;border-radius:8px}
.metric b{font-size:18px}
.small{font-size:13px;color:#666}
#map{height:420px;border-radius:8px}
.badge{padding:3px 6px;border-radius:6px;background:#e8f0ff;font-size:12px}
.record{padding:6px;border-radius:6px;cursor:pointer}
.record:hover{background:#f2f5f9}
hr{border:none;border-top:1px solid #eee;margin:8px 0}
</style>
</head>

<body>

<header>
  <h2>ğŸš¶ å¥èµ°è¿½è¹¤å™¨ï¼ˆå®Œæ•´åŠŸèƒ½ç‰ˆï¼‰</h2>
</header>

<div class="container">

<!-- åœ°åœ– -->
<div class="card">
  <div id="map"></div>
</div>

<!-- æ§åˆ¶ -->
<div class="card row">
  <button id="startBtn">é–‹å§‹</button>
  <button id="stopBtn" class="alt" disabled>çµæŸ</button>
  <button id="saveBtn" disabled>å„²å­˜</button>
</div>

<!-- å³æ™‚ -->
<div class="card row">
  <div class="metric">æ™‚é–“<br><b id="time">00:00:00</b></div>
  <div class="metric">è·é›¢ km<br><b id="dist">0.00</b></div>
</div>

<!-- ç¯©é¸ -->
<div class="card row">
  <b>æ—¥æœŸç¯©é¸</b>
  <input type="date" id="dateFilter">
  <button class="gray" onclick="clearFilter()">å…¨éƒ¨</button>
</div>

<!-- ç´€éŒ„ -->
<div class="card">
  <b>å¥èµ°ç´€éŒ„</b>
  <div id="history" class="small"></div>
</div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map=L.map('map').setView([25.03,121.56],15)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)

let watchId,startTime,currentSession=null
let marker,line

function load(){return JSON.parse(localStorage.getItem('walk_records')||'[]')}
function save(a){localStorage.setItem('walk_records',JSON.stringify(a))}

/* GPS */
function onPos(p){
  const {latitude,longitude}=p.coords
  const pt={lat:latitude,lng:longitude}
  if(!marker) marker=L.marker(pt).addTo(map)
  else marker.setLatLng(pt)
  if(!line) line=L.polyline([],{color:'#1e88e5'}).addTo(map)
  line.addLatLng(pt)
  currentSession.path.push(pt)
}

/* é–‹å§‹ */
startBtn.onclick=()=>{
  currentSession={id:Date.now(),start:new Date().toISOString(),path:[]}
  if(line){map.removeLayer(line);line=null}
  startTime=Date.now()
  watchId=navigator.geolocation.watchPosition(onPos)
  startBtn.disabled=true
  stopBtn.disabled=false
}

/* çµæŸ */
stopBtn.onclick=()=>{
  navigator.geolocation.clearWatch(watchId)
  stopBtn.disabled=true
  saveBtn.disabled=false
}

/* å„²å­˜ */
saveBtn.onclick=()=>{
  const sec=Math.floor((Date.now()-startTime)/1000)
  const rec={
    id:currentSession.id,
    dateOnly:currentSession.start.slice(0,10),
    duration:sec,
    path:currentSession.path,
    source:'gps'
  }
  const a=load();a.push(rec);save(a)
  currentSession=null
  saveBtn.disabled=true
  startBtn.disabled=false
  render()
}

/* æ¸²æŸ“ */
function render(){
  const f=dateFilter.value
  const a=load().filter(r=>!f||r.dateOnly===f)

  history.innerHTML=a.map(r=>`
    <div class="record">
      ğŸ“… ${r.dateOnly}ï½œ
      â± ${Math.round(r.duration/60)} åˆ†ï½œ
      <span class="badge">${r.source}</span>
      <button class="gray" onclick="play(${r.id})">å›æ”¾</button>
      <button class="danger" onclick="del(${r.id})">åˆªé™¤</button>
    </div>
  `).join('')
}

/* å›æ”¾ */
function play(id){
  const r=load().find(x=>x.id===id)
  if(!r||!r.path||!r.path.length) return alert('ç„¡è·¯å¾‘')
  if(line) map.removeLayer(line)
  line=L.polyline(r.path,{color:'red'}).addTo(map)
  map.fitBounds(line.getBounds())
}

/* åˆªé™¤ */
function del(id){
  if(!confirm('åˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ')) return
  save(load().filter(r=>r.id!==id))
  render()
}

function clearFilter(){
  dateFilter.value=''
  render()
}

dateFilter.onchange=render
render()
</script>

</body>
</html>
