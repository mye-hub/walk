<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å¥èµ°è¿½è¹¤å™¨ v2</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
body{margin:0;font-family:system-ui;background:#f5f7fb}
header{background:#fff;padding:12px 16px;border-bottom:1px solid #eee}
.container{max-width:1100px;margin:auto;padding:12px}
.card{background:#fff;border-radius:10px;padding:12px;margin-bottom:12px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
button{background:#1e88e5;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
button.alt{background:#4caf50}
button.warn{background:#ff9800}
button.danger{background:#ef4444}
.metric{flex:1;background:#f2f5f9;padding:8px;border-radius:8px}
.metric b{font-size:18px}
.small{font-size:13px;color:#666}
#map{height:420px;border-radius:8px}
.lifebar{height:16px;background:#eee;border-radius:8px;overflow:hidden}
.lifebar i{display:block;height:100%;background:#4caf50;width:0%}
.badge{padding:4px 8px;border-radius:6px;background:#e8f0ff;font-size:12px}
</style>
</head>

<body>

<header>
  <h2>ğŸš¶ å¥èµ°è¿½è¹¤å™¨ï¼ˆè£ç½®æ•´åˆç‰ˆï¼‰</h2>
  <div class="small">GPSï½œWeb Bluetoothï½œHealth Connectï½œApple Health</div>
</header>

<div class="container">

<!-- åœ°åœ–èˆ‡æ§åˆ¶ -->
<div class="card">
  <div id="map"></div>
  <div class="row" style="margin-top:10px">
    <button id="startBtn">é–‹å§‹å¥èµ°</button>
    <button id="stopBtn" class="alt" disabled>çµæŸ</button>
    <button id="saveBtn" disabled>å„²å­˜ç´€éŒ„</button>
    <span class="small">GPS ç²¾æº–åº¦ï¼š<span id="acc">-</span> m</span>
  </div>
</div>

<!-- å³æ™‚æ•¸æ“š -->
<div class="card row">
  <div class="metric">æ™‚é–“<br><b id="time">00:00:00</b></div>
  <div class="metric">è·é›¢ km<br><b id="dist">0.00</b></div>
  <div class="metric">é€Ÿåº¦ km/h<br><b id="speed">0.0</b></div>
  <div class="metric">å¼·åº¦<br><b id="intensity">-</b></div>
  <div class="metric">å¿ƒç‡ bpm<br><b id="hr">-</b></div>
</div>

<!-- è£ç½®é€£æ¥ -->
<div class="card">
  <b>è£ç½®èˆ‡å¥åº·è³‡æ–™</b>
  <div class="row" style="margin-top:6px">
    <button id="btBtn">é€£æ¥æ‰‹ç’°ï¼ˆWeb Bluetoothï¼‰</button>
    <button class="warn" onclick="mockHealth('health-connect')">åŒ¯å…¥ Android Health</button>
    <button class="warn" onclick="mockHealth('apple-health')">åŒ¯å…¥ Apple Health</button>
  </div>
  <div class="small">â€» Health Connect / Apple Health ç‚ºåŸç”Ÿ App å‘¼å«çš„æ¨¡æ“¬å…¥å£</div>
</div>

<!-- ç›®æ¨™ -->
<div class="card">
  <b>ä»Šæ—¥æ­¥æ•¸ç›®æ¨™</b>
  <input id="goal" type="number" value="8000" style="width:100%">
  <div class="lifebar"><i id="life"></i></div>
  <div class="small"><span id="lifeText">0%</span></div>
</div>

<!-- ç´€éŒ„ -->
<div class="card">
  <b>å¥èµ°ç´€éŒ„</b>
  <div id="history" class="small"></div>
  <div style="margin-top:8px;text-align:right">
    <button id="exportBtn">åŒ¯å‡º CSV</button>
    <button id="clearBtn" class="danger">æ¸…é™¤å…¨éƒ¨</button>
  </div>
</div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ========= ç‹€æ…‹ ========= */
let map, marker, line
let watchId=null, startTime=null, timer=null
let path=[]
let liveHR=null

/* ========= åˆå§‹åŒ–åœ°åœ– ========= */
map=L.map('map')
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)
navigator.geolocation.getCurrentPosition(p=>{
  map.setView([p.coords.latitude,p.coords.longitude],16)
})

/* ========= GPS ========= */
function onPos(p){
  const {latitude,longitude,accuracy}=p.coords
  acc.innerText=Math.round(accuracy)
  const ll=[latitude,longitude]
  if(!marker) marker=L.marker(ll).addTo(map)
  else marker.setLatLng(ll)
  if(!line) line=L.polyline([],{color:'#1e88e5'}).addTo(map)
  line.addLatLng(ll)
  path.push({lat:latitude,lng:longitude})
}

function start(){
  path=[]
  if(line){map.removeLayer(line);line=null}
  startTime=Date.now()
  watchId=navigator.geolocation.watchPosition(onPos)
  timer=setInterval(updateStats,1000)
  startBtn.disabled=true
  stopBtn.disabled=false
}

function stop(){
  navigator.geolocation.clearWatch(watchId)
  clearInterval(timer)
  updateStats()
  stopBtn.disabled=true
  saveBtn.disabled=false
}

/* ========= è¨ˆç®— ========= */
function updateStats(){
  const sec=Math.floor((Date.now()-startTime)/1000)
  time.innerText=format(sec)
  const km=calcDist(path)
  dist.innerText=km.toFixed(2)
  const sp=km/(sec/3600||1)
  speed.innerText=sp.toFixed(1)
  intensity.innerText=sp>=4?'ä¸­ç­‰':'ä½'
}

function calcDist(p){
  let d=0
  for(let i=1;i<p.length;i++) d+=hav(p[i-1],p[i])
  return d/1000
}
function hav(a,b){
  const R=6371000,toR=x=>x*Math.PI/180
  const dLat=toR(b.lat-a.lat),dLon=toR(b.lng-a.lng)
  return 2*R*Math.asin(Math.sqrt(
    Math.sin(dLat/2)**2+
    Math.cos(toR(a.lat))*Math.cos(toR(b.lat))*Math.sin(dLon/2)**2))
}
function format(s){
  const h=String(Math.floor(s/3600)).padStart(2,'0')
  s%=3600
  const m=String(Math.floor(s/60)).padStart(2,'0')
  return `${h}:${m}:${String(s%60).padStart(2,'0')}`
}

/* ========= å„²å­˜ ========= */
function load(){return JSON.parse(localStorage.getItem('walk_records')||'[]')}
function save(arr){localStorage.setItem('walk_records',JSON.stringify(arr))}

function saveSession(){
  const arr=load()
  const km=parseFloat(dist.innerText)
  arr.push({
    id:Date.now(),
    source:'gps',
    date:new Date().toISOString(),
    dateOnly:new Date().toISOString().slice(0,10),
    durationSec:Math.floor((Date.now()-startTime)/1000),
    distanceKm:km,
    steps:Math.round(km*1000/0.78),
    avgSpeed:parseFloat(speed.innerText),
    hr:liveHR
  })
  save(arr)
  saveBtn.disabled=true
  render()
}

/* ========= Health åŒ¯å…¥ï¼ˆåŸç”Ÿç”¨ï¼‰ ========= */
window.importHealthRecord=function(r){
  const arr=load()
  arr.push({...r,id:Date.now()})
  save(arr)
  render()
}

/* Demo æ¨¡æ“¬ */
function mockHealth(src){
  importHealthRecord({
    source:src,
    date:new Date().toISOString(),
    dateOnly:new Date().toISOString().slice(0,10),
    durationSec:1800,
    distanceKm:2.6,
    steps:3400,
    avgSpeed:5.2,
    hr:110
  })
}

/* ========= Web Bluetooth å¿ƒç‡ ========= */
btBtn.onclick=async()=>{
  if(!navigator.bluetooth) return alert('ä¸æ”¯æ´ Web Bluetooth')
  const dev=await navigator.bluetooth.requestDevice({filters:[{services:['heart_rate']}]})
  const server=await dev.gatt.connect()
  const svc=await server.getPrimaryService('heart_rate')
  const ch=await svc.getCharacteristic('heart_rate_measurement')
  ch.startNotifications()
  ch.oncharacteristicvaluechanged=e=>{
    liveHR=e.target.value.getUint8(1)
    hr.innerText=liveHR
  }
}

/* ========= UI ========= */
function render(){
  const arr=load()
  history.innerHTML=arr.map(r=>`
    ${r.dateOnly}ï½œ
    ${r.distanceKm}kmï½œ
    ${r.steps}æ­¥ï½œ
    <span class="badge">${r.source}</span>
  `).join('<br>')
  updateLife()
}

function updateLife(){
  const goalVal=parseInt(goal.value)
  const today=new Date().toISOString().slice(0,10)
  const steps=load().filter(r=>r.dateOnly===today).reduce((s,r)=>s+r.steps,0)
  const pct=Math.min(100,Math.round(steps/goalVal*100))
  life.style.width=pct+'%'
  lifeText.innerText=pct+'%'
}

/* ========= ç¶å®š ========= */
startBtn.onclick=start
stopBtn.onclick=stop
saveBtn.onclick=saveSession
clearBtn.onclick=()=>{localStorage.removeItem('walk_records');render()}
exportBtn.onclick=()=>{
  const a=load()
  let csv='date,distance,steps,source\n'
  a.forEach(r=>csv+=`${r.date},${r.distanceKm},${r.steps},${r.source}\n`)
  const b=new Blob([csv])
  const u=URL.createObjectURL(b)
  const l=document.createElement('a')
  l.href=u;l.download='walk.csv';l.click()
}
goal.onchange=updateLife

render()
</script>
</body>
</html>
