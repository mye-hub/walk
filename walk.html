<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>健走追蹤器 v2 — 團體模式、雲端同步、路線推薦</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <!-- Confetti (simple) -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      --bg:#f7fafc;--card:#ffffff;--accent:#1e88e5;--muted:#6b7280;
      --success:#16a34a;--danger:#ef4444;
    }
    body{font-family: system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; margin:0; background:var(--bg); color:#0f172a}
    header{background:linear-gradient(90deg,#fff,#eef6ff); padding:14px 18px; box-shadow:0 1px 0 rgba(0,0,0,0.04)}
    .container{max-width:1200px;margin:18px auto;padding:12px}
    h1{margin:0;font-size:20px}
    .layout{display:grid;grid-template-columns:1fr 420px;gap:14px}
    .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 10px 30px rgba(16,24,40,0.06)}
    #map{height:520px;border-radius:8px}
    button{background:var(--accent);color:white;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
    button.alt{background:#4caf50}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #e2e8f0}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:8px;align-items:center}
    .metric{display:flex;flex-direction:column;padding:8px;border-radius:8px;background:#f4f8fb}
    .metric .label{font-size:12px;color:#666}
    .metric .value{font-weight:700;font-size:18px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px dashed #eee;text-align:left}
    .small{font-size:13px}
    .flex-col{display:flex;flex-direction:column}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    a.inline{color:var(--accent);text-decoration:none}
    .danger{background:var(--danger)}
    footer{margin-top:12px;font-size:13px;color:var(--muted)}
    .lifebar{height:22px;background:#eee;border-radius:12px;overflow:hidden;display:flex;align-items:center}
    .lifebar > i{display:inline-block;width:100%;height:100%;background:linear-gradient(90deg,#ffb86b,#ff6b6b);border-radius:12px;transition:width 400ms}
    .goalRow{display:flex;gap:8px;align-items:center;margin-top:8px}
    .recommendation{margin-top:10px;padding:8px;border-radius:8px;background:#f7fbf9;border:1px solid #e6f4ec}
    .badge{background:#e8f0ff;padding:6px 8px;border-radius:8px;font-weight:700}
    .member-list{max-height:160px;overflow:auto;margin-top:8px}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;margin-right:6px;font-weight:600}
    .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .file-input{display:none}
    .btn-small{padding:6px 8px;font-size:13px;border-radius:6px}
    .tooltip{font-size:12px;color:#94a3b8}
    .ui-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  </style>
</head>
<body>
  <header>
    <div class="container row topbar">
      <div style="flex:1">
        <h1>健走追蹤器 v2 — 團體模式 & 雲端同步</h1>
        <div class="muted">新增功能：團體健走、地點標籤、雲端同步（Firebase）、匯入/匯出 CSV、變更目標按鈕、強化推薦路線、互動化 UI。</div>
      </div>
      <div class="row">
        <div id="authArea" class="row">
          <button id="signInBtn" class="btn-small ghost">使用 Google 登入</button>
          <button id="signOutBtn" class="btn-small" style="display:none">登出</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="layout">
      <section class="card">
        <div id="map"></div>

        <div style="display:flex;justify-content:space-between;margin-top:8px;align-items:center">
          <div class="muted">GPS 精準度: <span id="accuracy">-</span> 公尺</div>
          <div class="row">
            <button id="startBtn">開始健走</button>
            <button id="stopBtn" class="alt" disabled>結束</button>
            <button id="saveBtn" disabled>儲存本次</button>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <div class="badge">推薦路線</div>
          <div style="flex:1">
            <select id="prefSelect">
              <option value="park">靠近公園 / 景觀</option>
              <option value="quiet">安靜路線（避開主幹道）</option>
              <option value="scenic">風景優先</option>
            </select>
            <input id="desiredKm" type="number" min="0.5" step="0.5" value="3" style="width:80px;margin-left:6px"> km
            <label style="margin-left:6px"><input id="useRouting" type="checkbox" checked> 以路網路徑 (若可用)</label>
            <button id="recommendBtn" style="margin-left:6px">推薦</button>
          </div>
          <div class="muted small">可依地點搜尋附近公園並生成步行迴圈；若啟用空污檢查，會過濾 AQI 高的地區。</div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <div class="chip">版本：v2 (團體 + Cloud)</div>
          <div class="chip" id="connectedStatus">離線</div>
          <div style="flex:1" class="tooltip">提示：登入可啟用跨裝置同步與團體模式。</div>
        </div>

      </section>

      <aside class="card">
        <div class="flex-col">
          <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="metric">
              <div class="label">本次時間</div>
              <div class="value" id="duration">00:00:00</div>
            </div>
            <div class="metric">
              <div class="label">距離 (km)</div>
              <div class="value" id="distance">0.00</div>
            </div>
            <div class="metric">
              <div class="label">平均速度 (km/h)</div>
              <div class="value" id="avgSpeed">0.0</div>
            </div>
          </div>

          <div class="row" style="gap:10px;margin-bottom:10px">
            <div style="flex:1">
              <div class="label">強度判定</div>
              <div id="intensity" style="font-weight:700">-</div>
              <div class="muted small">建議：單次至少15分鐘，週累積150–300分鐘中等強度。</div>
            </div>
            <div style="width:120px">
              <div class="label">步數估算</div>
              <div id="estSteps" style="font-weight:700">-</div>
            </div>
          </div>

          <div>
            <div class="label">穿戴裝置即時數據</div>
            <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
              <button id="connectWearBtn">連接手錶 (Web Bluetooth)</button>
              <div class="muted small">心率: <span id="hr">-</span> bpm</div>
              <div class="muted small">即時步數: <span id="liveSteps">-</span></div>
            </div>
            <div class="muted small" style="margin-top:6px">若裝置不支援 Bluetooth，請使用手動輸入或匯入資料。</div>
          </div>

          <div style="margin-top:12px">
            <div class="label">目標設定（個人化）</div>
            <div class="goalRow">
              <div style="flex:1">
                <div class="small">每日步數目標</div>
                <input id="goalSteps" type="number" value="8000" style="width:100%">
              </div>
              <div style="flex:1">
                <div class="small">每週中等時數目標（分鐘）</div>
                <input id="goalWeeklyMin" type="number" value="150" style="width:100%">
              </div>
            </div>
            <div style="margin-top:8px" class="small">達成率（生命條）：</div>
            <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
              <div style="flex:1">
                <div class="small">今日步數達成</div>
                <div class="lifebar"><i id="lifeSteps" style="width:10%"></i></div>
              </div>
              <div style="width:110px;text-align:center">
                <div id="lifeStepsText">0%</div>
              </div>
            </div>

            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="saveGoalBtn" class="btn-small">儲存目標</button>
              <button id="resetGoalBtn" class="btn-small ghost">還原預設</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <div class="label">紀錄（依日期顯示）</div>

            <div style="display:flex;gap:8px;margin-top:6px;align-items:center">
              <input id="locationTag" placeholder="地點標籤（可選）" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eef2f7">
              <input id="importFile" class="file-input" type="file" accept=".csv" />
              <button id="importBtn" class="btn-small ghost">匯入 CSV</button>
            </div>

            <div id="historyContainer" style="max-height:220px;overflow:auto;margin-top:6px"></div>
            <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
              <button id="exportBtn" class="btn-small">匯出 CSV</button>
              <button id="clearBtn" class="danger btn-small">清除所有紀錄</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <div class="label">團體健走</div>
            <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
              <input id="roomId" placeholder="房間 ID (空白則自動產生)" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eef2f7"/>
              <button id="createRoomBtn" class="btn-small">建立房間</button>
              <button id="joinRoomBtn" class="btn-small ghost">加入房間</button>
            </div>
            <div class="muted small" style="margin-top:6px">房間建立後，其他人可輸入相同 ID 加入。登入可顯示名稱與雲端同步。</div>
            <div class="member-list" id="memberList"></div>
          </div>

        </div>
      </aside>
    </div>

    <div style="max-width:1200px;margin:18px auto">
      <div class="card">
        <h3>即時回饋建議</h3>
        <div id="feedback" class="recommendation">尚未開始健走</div>

        <div style="margin-top:12px;display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap">
          <div style="width:320px">
            <h4 class="small">每週步數趨勢</h4>
            <canvas id="weeklyChart" height="160"></canvas>
          </div>

          <div style="flex:1">
            <h4 class="small">小幫手</h4>
            <div class="muted small">
              - 建議：若速度低於 4 km/h，嘗試調速或延長時間。<br>
              - 團體模式：可互相比較配速；主持人可發起「暖身倒數」。<br>
              - 若要使用更精準的路網路徑，請啟用「以路網路徑」並填入 OSRM / GraphHopper endpoint（程式內有註解）。
            </div>
          </div>
        </div>

      </div>
    </div>

    <footer>
      進階功能：路線推薦使用 OpenStreetMap Overpass 與 OpenAQ 空氣品質。若要啟用雲端同步/團體功能，請填入 Firebase config（程式碼中有說明）。
    </footer>
  </main>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Firebase modular (v9+) -->
  <script type="module">
    // ========================
    // Firebase 設定說明（可選）
    // ========================
    // 若你要啟用「跨裝置同步」與「團體即時位置」功能：
    // 1) 建立 Firebase 專案
    // 2) 啟用 Authentication -> Google Sign-In
    // 3) 新增 Firestore（或使用 Realtime Database）
    // 4) 把下面 firebaseConfig 填入你的專案設定
    //
    // 我在此使用 Firestore (紀錄) 與 Realtime Database (房間位置)。如果你不想用 Firebase，
    // 可把 initFirebase()、auth 相關、room 相關部分移除，功能仍可在 localStorage 上運作。
    //
  </script>

  <script type="module">
    // --------- Firebase 初始化（填入你自己的設定） ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, setDoc, doc, onSnapshot, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";
    import { getDatabase, ref as dbRef, set as dbSet, onValue, remove as dbRemove } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-database.js";

    // --- 請換成你的 firebaseConfig ---
    const firebaseConfig = {
      // apiKey: "YOUR_API_KEY",
      // authDomain: "YOUR_PROJECT.firebaseapp.com",
      // projectId: "YOUR_PROJECT",
      // storageBucket: "YOUR_PROJECT.appspot.com",
      // messagingSenderId: "SENDER_ID",
      // appId: "APP_ID",
      // databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com" // for realtime DB
    };

    let app=null, auth=null, db=null, rtdb=null, user=null;
    function initFirebaseIfNeeded(){
      if(firebaseConfig.apiKey){
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        rtdb = getDatabase(app);
        setupAuthUI();
      } else {
        console.warn("Firebase 未設置，雲端同步與團體功能將停用。若要啟用請填入 firebaseConfig。");
        document.getElementById('connectedStatus').innerText = '離線（無 Firebase）';
      }
    }

    // ---------- 地圖與定位 ----------
    const map = L.map('map');
    let marker, polyline;
    let watchId = null; let path = []; let startTime = null; let timerInterval = null;
    const memberMarkers = {}; // room members

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OSM'}).addTo(map);
    if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(p=>{ map.setView([p.coords.latitude,p.coords.longitude],16); },()=>map.setView([25.0330,121.5654],13)); } else map.setView([25.0330,121.5654],13);

    function onPosition(pos){ const c = pos.coords; document.getElementById('accuracy').innerText = Math.round(c.accuracy)+' m'; const latlng = [c.latitude,c.longitude];
      if(!marker) marker = L.marker(latlng).addTo(map); else marker.setLatLng(latlng);
      if(path.length===0) map.panTo(latlng);
      if(!polyline) polyline = L.polyline([], {color:'#1e88e5',weight:5}).addTo(map);
      polyline.addLatLng(latlng);
      path.push({lat:c.latitude,lng:c.longitude,ts:Date.now(),acc:c.accuracy});
      // broadcast to room if in room
      if(currentRoomId && user){ broadcastPositionToRoom({lat:c.latitude,lng:c.longitude,ts:Date.now()}); }
    }

    function startWatch(){ if(!navigator.geolocation) return alert('此瀏覽器不支援 Geolocation'); path=[]; if(polyline){ map.removeLayer(polyline); polyline=null; } polyline = L.polyline([], {color:'#1e88e5',weight:5}).addTo(map); watchId = navigator.geolocation.watchPosition(onPosition,err=>{console.error(err);alert('取得位置失敗：'+err.message);},{enableHighAccuracy:true,maximumAge:1000,timeout:5000}); startTime = Date.now(); document.getElementById('startBtn').disabled=true; document.getElementById('stopBtn').disabled=false; document.getElementById('saveBtn').disabled=true; timerInterval = setInterval(updateStats,800); }
    function stopWatch(){ if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; } if(timerInterval){ clearInterval(timerInterval); timerInterval=null; } updateStats(); document.getElementById('startBtn').disabled=false; document.getElementById('stopBtn').disabled=true; document.getElementById('saveBtn').disabled=false; }

    function updateStats(){ const now = Date.now(); const durSec = startTime ? Math.floor((now - startTime)/1000) : 0; document.getElementById('duration').innerText = formatHMS(durSec); const distKm = calcDistanceFromPath(path); document.getElementById('distance').innerText = distKm.toFixed(2); const hours = durSec/3600 || 0.000001; const avgSpeed = distKm / hours; document.getElementById('avgSpeed').innerText = (avgSpeed||0).toFixed(1); const intensity = classifyIntensity(avgSpeed); document.getElementById('intensity').innerText = intensity.label + ' — ' + intensity.note; const steps = estimateSteps(distKm); document.getElementById('estSteps').innerText = Math.round(steps).toLocaleString() + ' 步'; updateFeedback(avgSpeed, document.getElementById('hr').innerText); updateLifeBar(); updateLiveStepsUI(); }

    function formatHMS(s){ const hh = String(Math.floor(s/3600)).padStart(2,'0'); s%=3600; const mm = String(Math.floor(s/60)).padStart(2,'0'); const ss = String(s%60).padStart(2,'0'); return hh+':'+mm+':'+ss; }
    function calcDistanceFromPath(p){ if(!p || p.length<2) return 0; let total=0; for(let i=1;i<p.length;i++){ total+=haversine(p[i-1],p[i]); } return total/1000; }
    function haversine(a,b){ const R=6371000; const toRad=v=>v*Math.PI/180; const dLat=toRad(b.lat-a.lat); const dLon=toRad(b.lng-a.lng); const lat1=toRad(a.lat); const lat2=toRad(b.lat); const aa=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2; const c=2*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa)); return R*c; }
    function classifyIntensity(kmh){ if(!kmh || kmh < 2.5) return {label:'非常緩步', note:'輕度活動'}; if(kmh < 4.0) return {label:'緩步', note:'低強度'}; if(kmh >=4.0 && kmh<6.0) return {label:'快步 (中等強度)', note:'建議每次至少15分'}; return {label:'快速/跑步 (高強度)', note:'高強度運動'}; }
    function estimateSteps(km){ const stepLength = 0.78; return (km*1000)/stepLength; }

    // ---------- 儲存、依日期分組顯示（支援地點標籤與雲端同步） ----------
    async function saveSession(){
      const durText=document.getElementById('duration').innerText;
      const distance=parseFloat(document.getElementById('distance').innerText)||0;
      const avgSpeed=parseFloat(document.getElementById('avgSpeed').innerText)||0;
      const steps=Math.round(estimateSteps(distance));
      const intensity=classifyIntensity(avgSpeed).label;
      const locationTag = document.getElementById('locationTag').value || '';
      const record = {
        id:'w_'+Date.now(),
        date:new Date().toISOString(),
        dateOnly: new Date().toISOString().slice(0,10),
        duration:durText,
        durationSec: Math.floor((Date.now()-startTime)/1000),
        distance:distance,
        avgSpeed:avgSpeed,
        steps:steps,
        intensity:intensity,
        path:path,
        locationTag: locationTag
      };
      // 儲存到 localStorage
      const arr=JSON.parse(localStorage.getItem('walk_records')||'[]');
      arr.push(record);
      localStorage.setItem('walk_records',JSON.stringify(arr));
      document.getElementById('saveBtn').disabled=true;
      refreshHistory();

      // 若登入則同步到雲端 (Firestore)
      if(user && db){
        try{
          const docRef = await addDoc(collection(db, 'walk_records'), {
            ...record,
            uid: user.uid,
            createdAt: serverTimestamp()
          });
          console.log('saved to cloud', docRef.id);
        } catch(e){
          console.warn('cloud save fail', e);
        }
      }

      // celebratory confetti
      confetti({
        particleCount: 60,
        spread: 70,
        origin: { y: 0.6 }
      });

      alert('已儲存本次健走紀錄');
    }

    function refreshHistory(){
      const container = document.getElementById('historyContainer'); container.innerHTML='';
      const arr = JSON.parse(localStorage.getItem('walk_records')||'[]');
      if(!arr.length){ container.innerHTML='<div class="muted small">尚無紀錄</div>'; updateWeeklyStats(arr); return; }
      const grouped = arr.reduce((acc,r)=>{ acc[r.dateOnly]=acc[r.dateOnly]||[]; acc[r.dateOnly].push(r); return acc; },{});
      const dates = Object.keys(grouped).sort((a,b)=>b.localeCompare(a));
      for(const d of dates){
        const dayCard = document.createElement('div'); dayCard.style.borderBottom='1px dashed #eee'; dayCard.style.padding='8px 0';
        dayCard.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${d} <span class='muted small'>(${grouped[d].length} 次)</span></div>`;
        grouped[d].sort((a,b)=>b.date.localeCompare(a.date));
        for(const r of grouped[d]){
          const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px 0';
          const locTagHtml = r.locationTag ? ` <span class="muted small">• ${r.locationTag}</span>` : '';
          row.innerHTML = `<div><div style='font-weight:600'>${new Date(r.date).toLocaleTimeString()}</div><div class='muted small'>${r.distance.toFixed(2)} km • ${r.duration} • ${r.intensity}${locTagHtml}</div></div><div><button data-id='${r.id}' class='viewBtn btn-small ghost'>檢視</button></div>`;
          dayCard.appendChild(row);
        }
        container.appendChild(dayCard);
      }
      document.querySelectorAll('.viewBtn').forEach(b=>b.addEventListener('click',e=>{ const id=e.currentTarget.dataset.id; const rec = arr.find(x=>x.id===id); if(rec) showRecordOnMap(rec); }));
      updateWeeklyStats(arr);
    }

    function showRecordOnMap(rec){ if(!rec.path||rec.path.length===0) return alert('此紀錄無 GPS 路徑'); if(polyline) map.removeLayer(polyline); polyline = L.polyline(rec.path.map(p=>[p.lat,p.lng]), {color:'#ff5722',weight:5}).addTo(map); map.fitBounds(polyline.getBounds(),{padding:[20,20]}); if(marker) map.removeLayer(marker); marker = L.marker([rec.path[0].lat, rec.path[0].lng]).addTo(map).bindPopup('起點').openPopup(); }

    function updateWeeklyStats(arr){
      const oneWeekAgo = Date.now() - 7*24*3600*1000;
      const week = arr.filter(r=> new Date(r.date).getTime() >= oneWeekAgo);
      const totalMin = Math.floor(week.reduce((s,r)=>s + (r.durationSec||0),0)/60);
      const totalSteps = week.reduce((s,r)=>s + (r.steps||0),0);
      const moderateCount = week.filter(r=> r.avgSpeed>=4.0).length;
      // update small chart dataset
      updateChartWithLocalData(arr);
    }

    // export / import / clear
    function exportCSV(){
      const arr=JSON.parse(localStorage.getItem('walk_records')||'[]'); if(!arr.length) return alert('沒有紀錄可匯出');
      const header=['id','date','duration','distance_km','avgSpeed_kmh','steps','intensity','locationTag'];
      const rows=arr.map(r=>[r.id,r.date,r.duration,r.distance,r.avgSpeed,r.steps,r.intensity, (r.locationTag||'')].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','));
      const csv=header.join(',')+'\n'+rows.join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='walk_records.csv'; document.body.appendChild(a); a.click(); a.remove();
    }
    function importCSVFile(file){
      const reader = new FileReader();
      reader.onload = e => {
        const text = e.target.result;
        const lines = text.split(/\r?\n/).filter(l=>l.trim());
        if(lines.length<2) return alert('CSV 格式錯誤或沒有資料');
        const header = lines[0].split(',');
        const rows = lines.slice(1).map(l => {
          // naive CSV parsing for common exported format
          const parts = l.split(',');
          return {
            id: parts[0].replace(/"/g,''),
            date: parts[1].replace(/"/g,''),
            duration: parts[2].replace(/"/g,''),
            distance: parseFloat(parts[3])||0,
            avgSpeed: parseFloat(parts[4])||0,
            steps: parseInt(parts[5])||0,
            intensity: parts[6] ? parts[6].replace(/"/g,'') : '',
            locationTag: parts[7] ? parts[7].replace(/"/g,'') : ''
          };
        });
        const arr = JSON.parse(localStorage.getItem('walk_records')||'[]');
        rows.forEach(r=>arr.push(r));
        localStorage.setItem('walk_records',JSON.stringify(arr));
        refreshHistory();
        alert('匯入完成');
      };
      reader.readAsText(file);
    }
    function clearAll(){ if(confirm('確定清除所有本地儲存的健走紀錄？此動作無法復原')){ localStorage.removeItem('walk_records'); refreshHistory(); alert('已清除'); } }

    // ---------- 路線推薦（改良版） ----------
    // 我保留原先使用 Overpass 查公園與 OpenAQ 的邏輯，並加入「以路網路徑」的選項。
    // 若你有 OSRM/GraphHopper 的 endpoint，可把它填入 useRoutingEndpoint 變數以取得實際路徑。
    const useRoutingEndpoint = ''; // 若有，請填入 OSRM/GraphHopper route endpoint（例如 https://router.project-osrm.org/route/v1/foot/）

    async function recommendRoute(){
      if(!marker) return alert('請先允許定位並取得起點');
      const latlng = marker.getLatLng();
      const pref = document.getElementById('prefSelect').value;
      const desiredKm = parseFloat(document.getElementById('desiredKm').value)||3;
      const parks = await fetchNearbyParks(latlng.lat, latlng.lng, 3000);
      const aqi = await fetchNearbyAQI(latlng.lat, latlng.lng);
      document.getElementById('feedback').innerText = `目前 AQI（附近測站）：${aqi?aqi+' (PM2.5 µg/m³)': '無資料'}`;
      let candidate=null;
      if(pref==='park' && parks.length){ candidate = parks[0]; }
      // 優先嘗試以路網產生步行路徑
      let route = null;
      if(document.getElementById('useRouting').checked && useRoutingEndpoint){
        try{
          if(candidate){
            route = await routeBetweenPointsUsingOSRM([latlng, {lat:candidate.lat, lng:candidate.lon}], desiredKm);
          } else {
            // 產生一個經過附近點的迴圈 (三段)
            const pts = generateLoopPoints(latlng.lat, latlng.lng, desiredKm, 6);
            route = await attemptRoutingOverPoints([latlng, ...pts.slice(0,3), latlng]);
          }
        } catch(e){
          console.warn('routing fail', e);
          route = null;
        }
      }
      if(!route){
        // fallback: generate approximate circular loop (以前的 generateLoop)
        if(candidate){
          route = [ [latlng.lat, latlng.lng], [candidate.lat, candidate.lon], ...generateLoop(candidate.lat,candidate.lon,desiredKm/2,6) ];
        } else {
          route = generateLoop(latlng.lat, latlng.lng, desiredKm);
        }
      }
      if(polyline) map.removeLayer(polyline);
      polyline = L.polyline(route, {color:'#2e7d32',weight:4,dashArray:'6,6'}).addTo(map);
      map.fitBounds(polyline.getBounds(),{padding:[20,20]});
      // 顯示候選地點
      if(candidate){ L.marker([candidate.lat,candidate.lon]).addTo(map).bindPopup(candidate.name || '附近公園').openPopup(); }
    }

    async function routeBetweenPointsUsingOSRM(points, targetKm){
      // points: array of {lat,lng} length 2
      // useRoutingEndpoint 必須有 /route/v1/foot/{lon,lat};... 格式
      // This function builds an OSRM query for the direct route.
      if(!useRoutingEndpoint) throw new Error('no routing endpoint');
      const coords = points.map(p=>`${p.lng || p.lon},${p.lat}`).join(';');
      const url = `${useRoutingEndpoint}${coords}?overview=full&geometries=geojson`;
      const res = await fetch(url);
      const obj = await res.json();
      if(obj.routes && obj.routes.length){
        const coords = obj.routes[0].geometry.coordinates.map(c=>[c[1], c[0]]);
        return coords;
      }
      throw new Error('no routes');
    }

    async function attemptRoutingOverPoints(points){
      // helper: try routing between consecutive points and concatenate
      if(!useRoutingEndpoint) throw new Error('no routing endpoint');
      let total = [];
      for(let i=0;i<points.length-1;i++){
        const a=points[i], b=points[i+1];
        const seg = await routeBetweenPointsUsingOSRM([a,b],0);
        total = total.concat(seg);
      }
      return total;
    }

    async function fetchNearbyParks(lat,lon,radius=3000){
      try{
        const q = `[out:json][timeout:25];(node[leisure=park](around:${radius},${lat},${lon});way[leisure=park](around:${radius},${lat},${lon});relation[leisure=park](around:${radius},${lat},${lon}););out center;`;
        const res = await fetch('https://overpass-api.de/api/interpreter', {method:'POST',body:q});
        const data = await res.json();
        const items=[];
        for(const el of data.elements){ const c = el.type==='node' ? {lat:el.lat,lon:el.lon} : (el.center||{}); items.push({id:el.id,name:el.tags&&el.tags.name,lat:c.lat,lon:c.lon}); }
        items.sort((a,b)=>a.name? -1:1);
        return items;
      } catch(e){ console.warn('Overpass fail',e); return []; }
    }

    async function fetchNearbyAQI(lat,lon){
      try{
        const res = await fetch(`https://api.openaq.org/v2/latest?coordinates=${lat},${lon}&radius=5000&parameter=pm25&limit=1`);
        const data = await res.json();
        if(data && data.results && data.results.length){ const val = data.results[0].measurements[0].value; return val.toFixed(1); }
        return null;
      } catch(e){ console.warn('AQ fetch fail',e); return null; }
    }

    function generateLoop(lat,lon,targetKm,points=12){
      const radiusM = (targetKm*1000)/ (2*Math.PI);
      const pts=[];
      for(let i=0;i<points;i++){
        const ang = (i/points)*2*Math.PI;
        const dLat = (radiusM/6371000) * (180/Math.PI) * Math.sin(ang);
        const dLng = (radiusM/6371000) * (180/Math.PI) * Math.cos(ang) / Math.cos(lat*Math.PI/180);
        pts.push([lat + dLat, lon + dLng]);
      }
      pts.push(pts[0]);
      return pts;
    }
    function generateLoopPoints(lat,lon,targetKm,points=6){
      const radiusM = (targetKm*1000)/ (2*Math.PI);
      const pts=[];
      for(let i=0;i<points;i++){
        const ang = (i/points)*2*Math.PI;
        const dLat = (radiusM/6371000) * (180/Math.PI) * Math.sin(ang);
        const dLng = (radiusM/6371000) * (180/Math.PI) * Math.cos(ang) / Math.cos(lat*Math.PI/180);
        pts.push({lat: lat + dLat, lng: lon + dLng});
      }
      return pts;
    }

    // ---------- Web Bluetooth: Heart Rate service (0x180D) ----------
    let hrMonitor = null;
    async function connectWearable(){ if(!navigator.bluetooth) return alert('此瀏覽器不支援 Web Bluetooth'); try{ const device = await navigator.bluetooth.requestDevice({filters:[{services:['heart_rate']}]}); const server = await device.gatt.connect(); const service = await server.getPrimaryService('heart_rate'); const char = await service.getCharacteristic('heart_rate_measurement'); await char.startNotifications(); char.addEventListener('characteristicvaluechanged', e=>{ const val = parseHeartRate(e.target.value); document.getElementById('hr').innerText = val; provideHRFeedback(val); }); alert('已連線至 '+device.name); } catch(e){ console.warn(e); alert('連線失敗：'+e.message); } }
    function parseHeartRate(dataView){ const flags = dataView.getUint8(0); const hrFormat = flags & 0x1; let rate = hrFormat ? dataView.getUint16(1,true) : dataView.getUint8(1); return rate; }

    // ---------- 即時回饋與卡路里估算 ----------
    function updateFeedback(kmh, hrText){
      const feedback = document.getElementById('feedback'); const hr = parseInt(hrText) || null; let msgs = [];
      if(kmh && kmh>0){ if(kmh>=4 && kmh<6) msgs.push('現在是中等強度（快步），很好，維持 15 分鐘以上效果佳。'); if(kmh<4) msgs.push('速度偏慢，若目標是中等強度，請提高步速至約 4 km/h。'); if(kmh>=6) msgs.push('速度偏快，注意呼吸與狀況。'); }
      if(hr){ if(hr<60) msgs.push('心率偏低，若覺得疲倦可提升強度。'); else if(hr>160) msgs.push('心率偏高，若不適請休息或放慢步伐。'); else msgs.push('心率在可接受範圍。'); }
      const weight = parseFloat(localStorage.getItem('user_weight'))||70; const durationMin = startTime ? Math.floor((Date.now()-startTime)/1000)/60 : 0; const met = kmhToMET(kmh); const kcal = Math.round(met * 3.5 * weight / 200 * durationMin);
      msgs.push(`估計已消耗 ${kcal} kcal（假設體重 ${weight} kg）`);
      feedback.innerHTML = msgs.join('<br>');
    }
    function kmhToMET(kmh){ if(!kmh) return 2; if(kmh<3) return 2.5; if(kmh<4) return 3.5; if(kmh<5) return 4.5; if(kmh<6) return 7.0; return 9; }
    function provideHRFeedback(hr){ if(!hr) return; const fb = document.getElementById('feedback'); if(hr>170) fb.innerHTML = '警示：心率過高，請立即減緩強度或停止。'; }

    // ---------- 生命條更新（目標達成） ----------
    function updateLifeBar(){
      const goalSteps = parseInt(document.getElementById('goalSteps').value)||8000;
      const today = new Date().toISOString().slice(0,10);
      const arr = JSON.parse(localStorage.getItem('walk_records')||'[]');
      const todaySteps=arr.filter(r=>r.dateOnly===today).reduce((s,r)=>s+(r.steps||0),0);
      const pct = Math.min(100, Math.round(todaySteps/goalSteps*100));
      document.getElementById('lifeSteps').style.width = pct+'%'; document.getElementById('lifeStepsText').innerText = pct+'%';
      document.getElementById('liveSteps').innerText = todaySteps.toLocaleString();
    }

    function updateLiveStepsUI(){
      // 更新當前路徑估算步數（不一定儲存）
      const distKm = calcDistanceFromPath(path);
      const steps = Math.round(estimateSteps(distKm));
      document.getElementById('liveSteps').innerText = steps.toLocaleString();
    }

    // ========== 團體模式 (Firebase Realtime DB) ==========
    let currentRoomId = null;
    async function createRoom(){
      if(!auth) return alert('此功能需 Firebase 支援並登入。');
      let id = document.getElementById('roomId').value.trim();
      if(!id) id = 'room_' + Math.random().toString(36).slice(2,8);
      const roomRef = dbRef(rtdb, `rooms/${id}`);
      // set minimal room metadata
      await dbSet(roomRef, { createdAt: Date.now(), host: user ? user.displayName || user.uid : 'guest' });
      listenRoomMembers(id);
      currentRoomId = id;
      document.getElementById('connectedStatus').innerText = '房間：' + id;
      alert('房間已建立：' + id);
    }

    function joinRoom(){
      if(!auth) return alert('此功能需 Firebase 支援並登入。');
      const id = document.getElementById('roomId').value.trim();
      if(!id) return alert('請輸入房間 ID');
      listenRoomMembers(id);
      currentRoomId = id;
      document.getElementById('connectedStatus').innerText = '房間：' + id;
      alert('已加入房間：' + id);
    }

    function listenRoomMembers(roomId){
      const membersRef = dbRef(rtdb, `rooms/${roomId}/members`);
      onValue(membersRef, snapshot => {
        const data = snapshot.val() || {};
        renderMemberList(data);
        // update markers
        for(const k of Object.keys(memberMarkers)){
          if(!data[k]){ // remove marker
            map.removeLayer(memberMarkers[k]);
            delete memberMarkers[k];
          }
        }
        for(const [k, v] of Object.entries(data)){
          if(v && v.lat && v.lng){
            if(memberMarkers[k]){
              memberMarkers[k].setLatLng([v.lat, v.lng]);
            } else {
              const m = L.marker([v.lat, v.lng], {title:v.name||k}).addTo(map).bindPopup(`<b>${v.name||k}</b><br>${v.steps?v.steps+' 步':''}`);
              memberMarkers[k]=m;
            }
          }
        }
      });
    }

    function renderMemberList(members){
      const el = document.getElementById('memberList'); el.innerHTML='';
      for(const [id, data] of Object.entries(members || {})){
        const div = document.createElement('div'); div.style.padding='6px 0'; div.style.borderBottom='1px dashed #eee';
        div.innerHTML = `<div style="font-weight:600">${data.name || id} <span class="muted small">(${data.status||'online'})</span></div><div class="muted small">${(data.distance||0).toFixed(2)} km • ${data.steps||0} 步</div>`;
        el.appendChild(div);
      }
    }

    // broadcast position to current room
    async function broadcastPositionToRoom(pos){
      if(!currentRoomId || !user || !rtdb) return;
      const key = user.uid;
      const data = {
        name: user.displayName || user.uid,
        lat: pos.lat,
        lng: pos.lng,
        ts: pos.ts,
        steps: Math.round(estimateSteps(calcDistanceFromPath(path))),
        distance: calcDistanceFromPath(path),
        status: 'moving'
      };
      await dbSet(dbRef(rtdb, `rooms/${currentRoomId}/members/${key}`), data);
      // set a timeout to clear presence if user stops (not implemented complex presence)
    }

    // cleanup presence on unload
    window.addEventListener('beforeunload', ()=>{
      if(user && currentRoomId && rtdb){
        dbRemove(dbRef(rtdb, `rooms/${currentRoomId}/members/${user.uid}`)).catch(()=>{});
      }
    });

    // ========== Chart: weekly steps ==========
    const chartCtx = document.getElementById('weeklyChart').getContext('2d');
    const weeklyChart = new Chart(chartCtx, {
      type: 'bar',
      data: { labels: [], datasets: [{ label: '步數', data: [] }] },
      options: { responsive:true, plugins:{legend:{display:false}} }
    });

    function updateChartWithLocalData(arr){
      // prepare 7 days labels
      const labels = [];
      const data = [];
      for(let i=6;i>=0;i--){
        const d = new Date(); d.setDate(d.getDate() - i);
        const key = d.toISOString().slice(0,10);
        labels.push(key.slice(5));
        const total = arr.filter(r=>r.dateOnly===key).reduce((s,r)=>s+(r.steps||0),0);
        data.push(total);
      }
      weeklyChart.data.labels = labels;
      weeklyChart.data.datasets[0].data = data;
      weeklyChart.update();
    }

    // ---------- Auth UI & Sync ----------
    function setupAuthUI(){
      const signInBtn = document.getElementById('signInBtn');
      const signOutBtn = document.getElementById('signOutBtn');
      signInBtn.addEventListener('click', async ()=>{
        const provider = new GoogleAuthProvider();
        try{
          const res = await signInWithPopup(auth, provider);
          user = res.user;
          document.getElementById('connectedStatus').innerText = '登入：' + (user.displayName || user.email);
          signInBtn.style.display='none'; signOutBtn.style.display='inline-block';
          // sync cloud -> local minimal merge
          syncCloudToLocal();
        } catch(e){ console.warn('signin fail', e); alert('登入失敗') }
      });
      signOutBtn.addEventListener('click', async ()=>{
        await signOut(auth);
      });
      onAuthStateChanged(auth, u=>{
        user = u;
        if(user){
          document.getElementById('connectedStatus').innerText = '登入：' + (user.displayName || user.email);
          signInBtn.style.display='none'; signOutBtn.style.display='inline-block';
        } else {
          document.getElementById('connectedStatus').innerText = '離線（未登入）';
          signInBtn.style.display='inline-block'; signOutBtn.style.display='none';
        }
      });
    }

    async function syncCloudToLocal(){
      if(!db || !user) return;
      // fetch user's cloud records and merge with local (dedupe by id)
      try{
        const q = query(collection(db,'walk_records'), where('uid','==', user.uid));
        const snap = await getDocs(q);
        const cloud = snap.docs.map(d=> ({...d.data()}));
        const local = JSON.parse(localStorage.getItem('walk_records')||'[]');
        const ids = new Set(local.map(r=>r.id));
        cloud.forEach(c=>{
          if(!ids.has(c.id)){
            local.push({
              id: c.id,
              date: (c.date || new Date().toISOString()),
              dateOnly: (c.date || '').slice(0,10) || new Date().toISOString().slice(0,10),
              duration: c.duration || '00:00:00',
              durationSec: c.durationSec || 0,
              distance: c.distance || 0,
              avgSpeed: c.avgSpeed || 0,
              steps: c.steps || 0,
              intensity: c.intensity || '',
              path: c.path || [],
              locationTag: c.locationTag || ''
            });
          }
        });
        localStorage.setItem('walk_records', JSON.stringify(local));
        refreshHistory();
      } catch(e){
        console.warn('sync fail', e);
      }
    }

    // ---------- UI handlers ----------
    document.getElementById('recommendBtn').addEventListener('click', recommendRoute);
    document.getElementById('connectWearBtn').addEventListener('click', connectWearable);
    document.getElementById('startBtn').addEventListener('click', ()=>startWatch());
    document.getElementById('stopBtn').addEventListener('click', ()=>stopWatch());
    document.getElementById('saveBtn').addEventListener('click', ()=>saveSession());
    document.getElementById('exportBtn').addEventListener('click', ()=>exportCSV());
    document.getElementById('clearBtn').addEventListener('click', ()=>clearAll());
    document.getElementById('saveGoalBtn').addEventListener('click', ()=>{
      localStorage.setItem('goal_steps', document.getElementById('goalSteps').value);
      localStorage.setItem('goal_weekly_min', document.getElementById('goalWeeklyMin').value);
      updateLifeBar();
      alert('目標已儲存');
    });
    document.getElementById('resetGoalBtn').addEventListener('click', ()=>{
      document.getElementById('goalSteps').value = 8000;
      document.getElementById('goalWeeklyMin').value = 150;
      localStorage.removeItem('goal_steps');
      localStorage.removeItem('goal_weekly_min');
      updateLifeBar();
      alert('已還原預設目標');
    });

    // import CSV
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    importBtn.addEventListener('click', ()=> importFile.click());
    importFile.addEventListener('change', (ev)=> {
      const f = ev.target.files[0];
      if(f) importCSVFile(f);
    });

    // create/join room
    document.getElementById('createRoomBtn').addEventListener('click', async ()=> {
      if(!app) return alert('請先在程式內設置 Firebase config。');
      await createRoom();
    });
    document.getElementById('joinRoomBtn').addEventListener('click', ()=> {
      if(!app) return alert('請先在程式內設置 Firebase config。');
      joinRoom();
    });

    // load initial
    function initFromStorage(){
      const g1 = localStorage.getItem('goal_steps'); if(g1) document.getElementById('goalSteps').value = g1;
      const g2 = localStorage.getItem('goal_weekly_min'); if(g2) document.getElementById('goalWeeklyMin').value = g2;
      refreshHistory();
      updateLifeBar();
      // chart
      updateChartWithLocalData(JSON.parse(localStorage.getItem('walk_records')||'[]'));
    }

    // sign-in buttons (for when firebase not set up)
    document.getElementById('signInBtn').addEventListener('click', ()=>{
      if(!firebaseConfig.apiKey) return alert('Firebase 尚未設定。請先把 firebaseConfig 填入程式碼以啟用登入與雲端同步。');
    });

    // initialize everything
    initFirebaseIfNeeded();
    initFromStorage();

    // If Firebase configured, auth UI is set up by initFirebaseIfNeeded()
  </script>
</body>
</html>
